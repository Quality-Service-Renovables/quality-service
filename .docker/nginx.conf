server {
    access_log /dev/stdout;
    error_log /dev/stderr;

    listen 443 ssl;
    listen [::]:443 ssl;

    #Solicitado por el LB de Oracle OCI
    keepalive_timeout 320s;
    keepalive_requests 1000;

    client_max_body_size 25M;

    root /app/public;
    index index.php index.html;

    ssl_certificate /etc/nginx/ssl/nginx.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.key;


    location / {

         # Establece los encabezados reales que recibe Nginx del proxy externo
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header SSL_PROTOCOL $ssl_protocol;
        proxy_set_header X-Forwarded $host;

        #Para mejorar el rendimiento
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        send_timeout 60s;

        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Indica a Nginx que confíe en los encabezados X-Forwarded-* provenientes de estos proxies
        set_real_ip_from 0.0.0.0/0; # Ajusta esto según la dirección IP de tu proxy
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;


        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;  # Asegúrate de que esta ruta coincida con la de tu configuración de PHP-FPM
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;

        #Para mejorar el rendimiento
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
    }

    # Previniendo el acceso a archivos ocultos .ht* .DS_Store .git
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Registrar errores
    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;

    # Habilitar gzip
        gzip on;
        gzip_disable "msie6"; # Deshabilitar para IE6

        # Configuración de los niveles de compresión
        gzip_vary on; # Agregar encabezado Vary
        gzip_proxied any; # Habilitar gzip para respuestas proxied
        gzip_comp_level 5; # Nivel de compresión, 5 es un buen equilibrio
        gzip_buffers 16 8k; # Buffers para gzip
        gzip_http_version 1.1; # HTTP/1.1 necesario para gzip
        gzip_min_length 256; # Longitud mínima para comprimir

        # Tipos de archivos a comprimir
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/javascript
            application/x-javascript
            application/json
            application/xml
            application/rss+xml
            application/rdf+xml
            application/xhtml+xml
            application/atom+xml
            application/geo+json
            application/ld+json
            application/manifest+json
            font/eot
            font/otf
            font/ttf
            font/opentype
            font/woff
            font/woff2
            image/svg+xml
            image/x-icon;

        # Configuración adicional para asegurar compatibilidad
        gzip_static on; # Habilitar gzip estático
        gzip_disable "msie6"; # Deshabilitar para IE6
        gzip_disable "Trident/7.0"; # Deshabilitar para IE11

        # Ajuste para evitar problemas de proxy
        gzip_proxied expired no-cache no-store private auth;
        gzip_types application/x-font-ttf application/vnd.ms-fontobject application/x-font-opentype application/x-font-truetype;
}
server {
    access_log /dev/stdout;
    error_log /dev/stderr;

    listen 80;
    listen [::]:80;

    #Solicitado por el LB de Oracle OCI
    keepalive_timeout 320s;
    keepalive_requests 1000;

    client_max_body_size 25M;

    root /app/public;
    index index.php index.html;

    ssl_certificate /etc/nginx/ssl/nginx.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.key;


    location / {

         # Establece los encabezados reales que recibe Nginx del proxy externo
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        #Para mejorar el rendimiento
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        send_timeout 60s;

        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Indica a Nginx que confíe en los encabezados X-Forwarded-* provenientes de estos proxies
        set_real_ip_from 0.0.0.0/0; # Ajusta esto según la dirección IP de tu proxy
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;


        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;  # Asegúrate de que esta ruta coincida con la de tu configuración de PHP-FPM
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;

        #Para mejorar el rendimiento
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
    }

    # Previniendo el acceso a archivos ocultos .ht* .DS_Store .git
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Registrar errores
    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;

    # Habilitar gzip
        gzip on;
        gzip_disable "msie6"; # Deshabilitar para IE6

        # Configuración de los niveles de compresión
        gzip_vary on; # Agregar encabezado Vary
        gzip_proxied any; # Habilitar gzip para respuestas proxied
        gzip_comp_level 5; # Nivel de compresión, 5 es un buen equilibrio
        gzip_buffers 16 8k; # Buffers para gzip
        gzip_http_version 1.1; # HTTP/1.1 necesario para gzip
        gzip_min_length 256; # Longitud mínima para comprimir

        # Tipos de archivos a comprimir
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/javascript
            application/x-javascript
            application/json
            application/xml
            application/rss+xml
            application/rdf+xml
            application/xhtml+xml
            application/atom+xml
            application/geo+json
            application/ld+json
            application/manifest+json
            font/eot
            font/otf
            font/ttf
            font/opentype
            font/woff
            font/woff2
            image/svg+xml
            image/x-icon;

        # Configuración adicional para asegurar compatibilidad
        gzip_static on; # Habilitar gzip estático
        gzip_disable "msie6"; # Deshabilitar para IE6
        gzip_disable "Trident/7.0"; # Deshabilitar para IE11

        # Ajuste para evitar problemas de proxy
        gzip_proxied expired no-cache no-store private auth;
        gzip_types application/x-font-ttf application/vnd.ms-fontobject application/x-font-opentype application/x-font-truetype;
}

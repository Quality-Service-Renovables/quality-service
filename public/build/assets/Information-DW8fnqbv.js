import{q as h,r as a,o as d,e as y,a as u,b as n,w as o,c as g,F as V,y as w,E as A,x as C,d as B}from"./app-CjLPoRMk.js";import{g as j}from"./api-kShYN9M8.js";import{Q as T}from"./vue-quill.esm-bundler-CDSfNZEB.js";import{_ as z}from"./PrimaryButton-B84KU01C.js";/* empty css                       */import{_ as S}from"./_plugin-vue_export-helper-DlAUqK2U.js";const N={components:{QuillEditor:T,PrimaryButton:z},props:{inspection_uuid:String,project:Object},data(){return{isUpdating:!1,loading:!1,inspection_form:{inspection_uuid:null,resume:"",conclusion:"",recomendations:"",ct_inspection_code:"",status_code:"",client_uuid:"",project_uuid:"",fields:[]},inspections:[],inspectionsEquipmentsCategories:[],inspectionsEquipmentsToUseInInspections:[],loadingInspectionAsignin:!1,errorAssigningInspection:!1,equipmentsByCategory:[],ct_risks:[]}},mounted(){this.getInspections(),this.getinspectionsEquipmentsCategories(),this.getRisks(),this.inspection_uuid!==null&&(this.isUpdating=!0,this.getInspection())},methods:{getInspections(){axios.get("api/inspection/categories").then(t=>{this.inspections=t.data.data}).catch(t=>{this.handleErrors(t)})},async getInspection(){try{this.loading=!0;const t=await j(this.inspection_uuid);this.inspection_form=t.data.data,this.inspection_form.ct_inspection_code=this.inspection_form.category.ct_inspection_code,this.inspection_form.ct_equipment_uuid=this.inspection_form.inspection_equipments.length>0?this.inspection_form.inspection_equipments[0].equipment.category.ct_equipment_uuid:null,this.inspection_form.equipments_uuid=this.inspection_form.inspection_equipments.map(i=>i.equipment.equipment_uuid),this.setEquipmentFields(this.inspection_form.ct_equipment_uuid),this.loading=!1}catch(t){this.loading=!1,this.handleErrors(t)}},getinspectionsEquipmentsCategories(){axios.get("api/equipment/categories").then(t=>{this.inspectionsEquipmentsCategories=t.data.data,this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsCategories.filter(i=>i.ct_equipment_code==="inspeccion"),this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsToUseInInspections.length?this.inspectionsEquipmentsToUseInInspections[0].equipments:[]}).catch(t=>{this.handleErrors(t)})},setEquipmentFields(t){if(console.log("Entro a setEquipmentFields"),console.log("ct_equipment_uuid: "+t),t){this.inspection_form.fields=null;let i=this.inspectionsEquipmentsCategories.find(c=>c.ct_equipment_uuid===t);this.inspection_form.fields=i.required_fields_report&&i.required_fields_report.length>0?JSON.parse(i.required_fields_report).fields:[];let r=this.inspection_form.equipment_fields_report!=null?JSON.parse(this.inspection_form.equipment_fields_report):null;this.inspection_form.fields.forEach(c=>{if(r&&r.length>0){let e=r.find(p=>p.key===c.key);c.value=e?e.value:""}else c.value=""}),this.equipmentsByCategory=i.equipments.length>0?i.equipments:[]}},isRequiredLabel(t){return t?"Requerido":"Opcional"},async asignInspection(){console.log("Asignar inspección"),this.loadingInspectionAsignin=!0;try{await this.createInspection(),await this.asignEquipmentToInspection()}catch{h.error("Error al asignar inspección, favor de verificar los datos ingresados.")}this.loadingInspectionAsignin=!1,this.errorAssigningInspection||(console.log("this.errorAssigningInspection: "+this.errorAssigningInspection),this.$inertia.reload())},createInspection(){return new Promise((t,i)=>{let r=null;if(this.isUpdating){console.log("Actualizando inspección"),r=()=>axios.put("api/inspections/"+this.inspection_form.inspection_uuid,c);let c={resume:this.inspection_form.resume,conclusion:"Por definir",ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id}}else{console.log("Creando inspección");let c={resume:this.inspection_form.resume,conclusion:"Por definir",ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id};r=()=>axios.post("api/inspections",c)}h.promise(r(),{loading:this.isUpdating?"Actualizando inspección...":"Asignando inspección...",success:c=>{this.inspection_form.inspection_uuid=c.data.data.inspection_uuid,this.$emit("setInspectionUuid",this.inspection_form.inspection_uuid);let e=this.isUpdating?"Inspección actualizada correctamente":"Inspección asignada correctamente";return t(e),e},error:c=>{this.errorAssigningInspection=!0,this.handleErrors(c),i(c)}})})},asignEquipmentToInspection(){return new Promise((t,i)=>{let r=this.inspection_form.equipments_uuid.map(e=>({equipment_uuid:e}));const c=()=>this.isUpdating?axios.put("api/inspection/equipments/"+this.inspection_form.inspection_uuid,{inspection_uuid:this.inspection_form.inspection_uuid,equipments:r}):axios.post("api/inspection/equipments",{inspection_uuid:this.inspection_form.inspection_uuid,equipments:r});h.promise(c(),{loading:this.isUpdating?"Actualizando equipos de inspección...":"Asignando equipos a inspección...",success:e=>{let p=this.isUpdating?"Actualización completada correctamente":"Asignación completada correctamente";return t(p),p},error:e=>{this.errorAssigningInspection=!0,this.handleErrors(e),i(e)}})})},getRisks(){axios.get("api/risks").then(t=>{this.ct_risks=t.data.data}).catch(t=>{this.handleErrors(t)})},getBgColor(t){let i=this.ct_risks.filter(r=>t===r.ct_risk_id);return i.length>0?i[0].ct_color:""}}},P={class:"max-w-7xl mx-auto sm:px-4 lg:px-6 mb-5 pb-5"},R={class:"overflow-hidden shadow-sm sm:rounded-lg"},F=u("p",{class:"text-grey mb-2 text-h5 font-weight-bold"}," Información del proyecto ",-1),O=u("p",{class:"text-primary"},"Rellena la información relacionada a la inspección a realizar.",-1),D=u("p",{class:"text-grey mb-1"},"Define el resumen de la inspección a realizar (opcional) ",-1),J=u("p",{class:"text-primary"},"Define los datos del equipo a inspeccionar. ",-1),Q=u("p",{class:"text-red mb-2"},"*No se han definido campos para la categoría seleccionada",-1),L=u("p",{class:"text-primary mb-2"},"Define la Escala de condición.",-1),G=u("p",{class:"text-grey mb-1"},"Escala de condición ",-1),H=u("p",{class:"mt-3 text-grey"}," Riesgo:",-1);function K(t,i,r,c,e,p){const I=a("v-divider"),_=a("v-autocomplete"),l=a("v-col"),q=a("v-text-field"),v=a("QuillEditor"),m=a("v-row"),E=a("v-list-item"),x=a("PrimaryButton"),k=a("v-card-text"),b=a("v-card");return d(),y("div",P,[u("div",R,[n(b,{loading:e.loading,disabled:e.loading},{default:o(()=>[n(k,null,{default:o(()=>[F,O,n(I,{class:"my-3"}),n(m,null,{default:o(()=>[n(l,{cols:"12"},{default:o(()=>[n(_,{modelValue:e.inspection_form.ct_inspection_code,"onUpdate:modelValue":i[0]||(i[0]=s=>e.inspection_form.ct_inspection_code=s),items:e.inspections,"item-title":"ct_inspection","item-value":"ct_inspection_code",label:"Seleccionar inspección",variant:"outlined","hide-details":"",required:""},null,8,["modelValue","items"])]),_:1}),n(l,{cols:"12",lg:"6"},{default:o(()=>[n(_,{modelValue:e.inspection_form.ct_equipment_uuid,"onUpdate:modelValue":[i[1]||(i[1]=s=>e.inspection_form.ct_equipment_uuid=s),i[2]||(i[2]=s=>p.setEquipmentFields(e.inspection_form.ct_equipment_uuid))],items:e.inspectionsEquipmentsCategories,"item-title":"ct_equipment","item-value":"ct_equipment_uuid",label:"Seleccionar categoría de equipo a inspeccionar",variant:"outlined","hide-details":"",required:""},null,8,["modelValue","items"])]),_:1}),n(l,{cols:"12",lg:"6"},{default:o(()=>[n(_,{modelValue:e.inspection_form.equipments_uuid,"onUpdate:modelValue":i[3]||(i[3]=s=>e.inspection_form.equipments_uuid=s),items:e.equipmentsByCategory,"item-title":"equipment","item-value":"equipment_uuid",label:"Seleccionar equipos a utilizar en la inspección",variant:"outlined","hide-details":"",multiple:"",chips:"",clearable:""},null,8,["modelValue","items"])]),_:1}),n(l,{cols:"12"},{default:o(()=>[n(q,{modelValue:e.inspection_form.location,"onUpdate:modelValue":i[4]||(i[4]=s=>e.inspection_form.location=s),label:"Ubicación",variant:"outlined","hide-details":"",required:""},null,8,["modelValue"])]),_:1}),n(l,{cols:"12"},{default:o(()=>[D,n(v,{content:e.inspection_form.resume,"onUpdate:content":i[5]||(i[5]=s=>e.inspection_form.resume=s),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"])]),_:1}),n(l,{cols:"12"},{default:o(()=>[e.inspection_form.fields.length?(d(),g(m,{key:0},{default:o(()=>[n(l,{cols:"12"},{default:o(()=>[J]),_:1}),(d(!0),y(V,null,w(e.inspection_form.fields,(s,f)=>(d(),g(l,{cols:"12",lg:"6",key:f},{default:o(()=>[n(q,{modelValue:s.value,"onUpdate:modelValue":U=>s.value=U,label:s.name+" ("+p.isRequiredLabel(s.required)+")",variant:"outlined","hide-details":"",required:""},null,8,["modelValue","onUpdate:modelValue","label"])]),_:2},1024))),128))]),_:1})):(d(),g(m,{key:1},{default:o(()=>[n(l,{cols:"12"},{default:o(()=>[Q]),_:1})]),_:1}))]),_:1})]),_:1}),n(m,null,{default:o(()=>[n(l,{cols:"12"},{default:o(()=>[L,G,n(v,{content:e.inspection_form.escala_condicion,"onUpdate:content":i[6]||(i[6]=s=>e.inspection_form.escala_condicion=s),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"]),H,n(_,{modelValue:e.inspection_form.ct_risk_id,"onUpdate:modelValue":i[7]||(i[7]=s=>e.inspection_form.ct_risk_id=s),items:e.ct_risks,"item-title":"ct_risk","item-value":"ct_risk_id",variant:"outlined","hide-details":"",class:"w-50 rounded",density:"compact",style:A({"background-color":p.getBgColor(e.inspection_form.ct_risk_id)})},{item:o(({props:s,item:f})=>[n(E,C(s,{title:f.raw.ct_risk,style:{"background-color":f.raw.ct_color},value:"ct_risk"}),null,16,["title","style"])]),_:1},8,["modelValue","items","style"])]),_:1})]),_:1}),n(x,{onClick:i[8]||(i[8]=s=>p.asignInspection()),disabled:!1,loading:!1,class:"mt-3"},{default:o(()=>[B(" Guardar ")]),_:1})]),_:1})]),_:1},8,["loading","disabled"])])])}const ee=S(N,[["render",K]]);export{ee as default};

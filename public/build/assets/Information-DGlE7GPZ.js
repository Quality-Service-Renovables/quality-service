import{G as T,H as R,I as M,J as N,K as j,M as Y,N as z,P as O,R as J,S as L,U as Q,V as K,j as G,W as H,X as W,Y as D,_ as A,$ as F,b as s,a0 as X,x as b,q as x,r as d,o as h,e as B,a as _,w as l,c as y,g as C,F as Z,z as $,f as ee,C as ie,a1 as te,d as ne}from"./app-DGJgTR83.js";import{g as se}from"./api-BZ6rAa2F.js";import{Q as oe}from"./vue-quill.esm-bundler-C1pGlFQC.js";import{_ as re}from"./PrimaryButton-BRsI7DRP.js";/* empty css                       */import{h as S}from"./moment-Cl4UOzQZ.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ce=T({hideActions:Boolean,...R(),...M(),...N({placeholder:"mm/dd/yyyy",prependIcon:"$calendar"}),...j(Y({weeksInMonth:"dynamic",hideHeader:!0}),["active"])},"VDateInput"),ae=z()({name:"VDateInput",props:ce(),emits:{"update:modelValue":i=>!0},setup(i,t){let{slots:o}=t;const{t:c}=O(),e=J(),{isFocused:u,focus:g,blur:k}=L(i),r=Q(i,"modelValue",i.multiple?[]:null),p=K(!1),V=G(()=>{const a=H(r.value);if(!a.length)return null;if(i.multiple===!0)return c("$vuetify.datePicker.itemsSelected",a.length);if(i.multiple==="range"){const f=a[0],v=a[a.length-1];return e.isValid(f)&&e.isValid(v)?`${e.format(f,"keyboardDate")} - ${e.format(v,"keyboardDate")}`:""}return e.isValid(r.value)?e.format(r.value,"keyboardDate"):""});function q(a){if(a.key!=="Enter")return;if(!p.value||!u.value){p.value=!0;return}const f=a.target;r.value=e.date(f.value)}function I(a){a.preventDefault(),a.stopPropagation(),p.value=!0}function U(){p.value=!1}W(()=>{const a=D.filterProps(i),f=A.filterProps(j(i,["active"])),v=F.filterProps(i);return s(F,b(v,{modelValue:V.value,onKeydown:q,focused:p.value||u.value,onFocus:g,onBlur:k,"onClick:control":I,"onClick:prepend":I}),{default:()=>{var n;return[s(X,{modelValue:p.value,"onUpdate:modelValue":m=>p.value=m,activator:"parent","min-width":"0",closeOnContentClick:!1,openOnClick:!1},{default:()=>[s(D,b(a,{modelValue:r.value,"onUpdate:modelValue":m=>r.value=m,onSave:U}),{default:m=>{let{actions:w,model:P}=m;return s(A,b(f,{modelValue:i.hideActions?r.value:P.value,"onUpdate:modelValue":E=>{i.hideActions?(r.value=E,i.multiple||(p.value=!1)):P.value=E},onMousedown:E=>E.preventDefault()}),{actions:i.hideActions?void 0:()=>w})}})]}),(n=o.default)==null?void 0:n.call(o)]}})})}}),ue={components:{QuillEditor:oe,PrimaryButton:re,VDateInput:ae},props:{inspection_uuid:String,project:Object},data(){return{isUpdating:!1,loading:!1,inspection_form:{inspection_uuid:null,resume:"",recomendations:"",ct_inspection_code:"",status_code:"",client_uuid:"",project_uuid:"",fields:[]},inspections:[],inspectionsEquipmentsCategories:[],inspectionsEquipmentsToUseInInspections:[],loadingInspectionAsignin:!1,errorAssigningInspection:!1,equipmentsByCategory:[],ct_risks:[],rules:[i=>i?!0:"Este campo es requerido."]}},mounted(){this.getInspections(),this.getinspectionsEquipmentsCategories(),this.getRisks(),this.inspection_uuid!==null&&(this.isUpdating=!0,this.getInspection())},methods:{getInspections(){axios.get("api/inspection/categories").then(i=>{this.inspections=i.data.data}).catch(i=>{this.handleErrors(i)})},async getInspection(){try{this.loading=!0;const i=await se(this.inspection_uuid);this.inspection_form=i.data.data,this.inspection_form.ct_inspection_code=this.inspection_form.category.ct_inspection_code,this.inspection_form.ct_equipment_uuid=this.inspection_form.inspection_equipments.length>0?this.inspection_form.inspection_equipments[0].equipment.category.ct_equipment_uuid:null,this.inspection_form.equipments_uuid=this.inspection_form.inspection_equipments.map(t=>t.equipment.equipment_uuid),this.setEquipmentFields(this.inspection_form.ct_equipment_uuid),this.loading=!1}catch(i){this.loading=!1,this.handleErrors(i)}},getinspectionsEquipmentsCategories(){axios.get("api/equipment/categories").then(i=>{this.inspectionsEquipmentsCategories=i.data.data,this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsCategories.filter(t=>t.ct_equipment_code==="inspeccion"),this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsToUseInInspections.length?this.inspectionsEquipmentsToUseInInspections[0].equipments:[]}).catch(i=>{this.handleErrors(i)})},setEquipmentFields(i,t=null){if(i){this.inspection_form.fields=null;let o=this.inspectionsEquipmentsCategories.find(e=>e.ct_equipment_uuid===i);this.inspection_form.fields=o.required_fields_report&&o.required_fields_report.length>0?JSON.parse(o.required_fields_report).fields:[];let c=this.inspection_form.equipment_fields_report!=null?JSON.parse(this.inspection_form.equipment_fields_report):null;this.inspection_form.fields.forEach(e=>{if(c&&c.length>0){let u=c.find(g=>g.key===e.key);e.value=u?u.value:""}else e.value=""}),this.equipmentsByCategory=o.equipments.length>0?o.equipments:[]}t==="change"&&(this.inspection_form.equipments_uuid=[])},isRequiredLabel(i){return i?"Requerido":"Opcional"},async asignInspection(i){i.preventDefault();const{valid:t}=await this.$refs.form.validate();if(t){console.log("Asignar inspección"),this.loadingInspectionAsignin=!0;try{await this.createInspection(),await this.asignEquipmentToInspection()}catch{x.error("Error al asignar inspección, favor de verificar los datos ingresados.")}this.loadingInspectionAsignin=!1,this.errorAssigningInspection||(console.log("this.errorAssigningInspection: "+this.errorAssigningInspection),this.$inertia.reload())}else x.error("Parece que faltan algunos campos por rellenar.")},createInspection(){return new Promise((i,t)=>{let o=null;if(this.isUpdating){console.log("Actualizando inspección"),o=()=>axios.put("api/inspections/"+this.inspection_form.inspection_uuid,c);let c={resume:this.inspection_form.resume,ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id,inspection_date:S(this.inspection_form.inspection_date).format("YYYY-MM-DD")}}else{console.log("Creando inspección");let c={resume:this.inspection_form.resume,ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id,inspection_date:S(this.inspection_form.inspection_date).format("YYYY-MM-DD")};o=()=>axios.post("api/inspections",c)}x.promise(o(),{loading:this.isUpdating?"Actualizando inspección...":"Asignando inspección...",success:c=>{this.inspection_form.inspection_uuid=c.data.data.inspection_uuid,this.$emit("setInspectionUuid",this.inspection_form.inspection_uuid);let e=this.isUpdating?"Inspección actualizada correctamente":"Inspección asignada correctamente";return i(e),e},error:c=>{this.errorAssigningInspection=!0,this.handleErrors(c),t(c)}})})},asignEquipmentToInspection(){return new Promise((i,t)=>{let o=this.inspection_form.equipments_uuid.map(e=>({equipment_uuid:e}));const c=()=>this.isUpdating?axios.put("api/inspection/equipments/"+this.inspection_form.inspection_uuid,{inspection_uuid:this.inspection_form.inspection_uuid,equipments:o}):axios.post("api/inspection/equipments",{inspection_uuid:this.inspection_form.inspection_uuid,equipments:o});x.promise(c(),{loading:this.isUpdating?"Actualizando equipos de inspección...":"Asignando equipos a inspección...",success:e=>{let u=this.isUpdating?"Actualización completada correctamente":"Asignación completada correctamente";return i(u),u},error:e=>{this.errorAssigningInspection=!0,this.handleErrors(e),t(e)}})})},getRisks(){axios.get("api/risks").then(i=>{this.ct_risks=i.data.data}).catch(i=>{this.handleErrors(i)})},getBgColor(i){let t=this.ct_risks.filter(o=>i===o.ct_risk_id);return t.length>0?t[0].ct_color:""}}},pe={class:"max-w-7xl mx-auto sm:px-4 lg:px-6 mb-5 pb-5"},de={class:"overflow-hidden shadow-sm sm:rounded-lg"},me=_("p",{class:"text-grey mb-2 text-h5 font-weight-bold"}," Información de la inspección ",-1),_e=_("p",{class:"text-primary"},"Rellena la información relacionada a la inspección.",-1),fe=_("p",{class:"text-grey mb-1"},"Define el resumen de la inspección (opcional) ",-1),he=_("p",{class:"text-primary"},"Define los datos del equipo. ",-1),ge=_("p",{class:"text-red mb-2"},"*No se han definido campos para la categoría seleccionada",-1),qe=_("p",{class:"text-primary mb-2"},"Define la Escala de condición.",-1),ve=_("p",{class:"text-grey mb-1"},"Escala de condición ",-1),ye=_("p",{class:"mt-3 text-grey"}," Riesgo:",-1);function ke(i,t,o,c,e,u){const g=d("v-divider"),k=d("v-text-field"),r=d("v-col"),p=d("v-autocomplete"),V=d("QuillEditor"),q=d("v-row"),I=d("v-list-item"),U=d("PrimaryButton"),a=d("v-card-text"),f=d("v-card"),v=d("v-form");return h(),B("div",pe,[_("div",de,[s(v,{ref:"form"},{default:l(()=>[s(f,{loading:e.loading,disabled:e.loading},{default:l(()=>[s(a,null,{default:l(()=>[me,_e,s(g,{class:"my-3"}),s(q,null,{default:l(()=>[s(r,{cols:"12"},{default:l(()=>[s(k,{modelValue:e.inspection_form.inspection_date,"onUpdate:modelValue":t[0]||(t[0]=n=>e.inspection_form.inspection_date=n),label:"Fecha de inspección",variant:"outlined","hide-details":"",required:"",rules:e.rules,type:"date"},null,8,["modelValue","rules"])]),_:1}),s(r,{cols:"12"},{default:l(()=>[e.inspections.length?(h(),y(p,{key:0,modelValue:e.inspection_form.ct_inspection_code,"onUpdate:modelValue":t[1]||(t[1]=n=>e.inspection_form.ct_inspection_code=n),items:e.inspections,"item-title":"ct_inspection","item-value":"ct_inspection_code",label:"Seleccionar inspección",variant:"outlined","hide-details":"",required:"",rules:e.rules},null,8,["modelValue","items","rules"])):C("",!0)]),_:1}),s(r,{cols:"12",lg:"6"},{default:l(()=>[e.inspectionsEquipmentsCategories.length?(h(),y(p,{key:0,modelValue:e.inspection_form.ct_equipment_uuid,"onUpdate:modelValue":[t[2]||(t[2]=n=>e.inspection_form.ct_equipment_uuid=n),t[3]||(t[3]=n=>u.setEquipmentFields(e.inspection_form.ct_equipment_uuid,"change"))],items:e.inspectionsEquipmentsCategories,"item-title":"ct_equipment","item-value":"ct_equipment_uuid",label:"Seleccionar categoría de equipo a inspeccionar",variant:"outlined","hide-details":"",required:""},null,8,["modelValue","items"])):C("",!0)]),_:1}),s(r,{cols:"12",lg:"6"},{default:l(()=>[s(p,{modelValue:e.inspection_form.equipments_uuid,"onUpdate:modelValue":t[4]||(t[4]=n=>e.inspection_form.equipments_uuid=n),items:e.equipmentsByCategory,"item-title":"equipment","item-value":"equipment_uuid",label:"Seleccionar equipos a utilizar en la inspección",variant:"outlined","hide-details":"",multiple:"",chips:"",clearable:"",required:"",rules:e.rules},null,8,["modelValue","items","rules"])]),_:1}),s(r,{cols:"12"},{default:l(()=>[s(k,{modelValue:e.inspection_form.location,"onUpdate:modelValue":t[5]||(t[5]=n=>e.inspection_form.location=n),label:"Ubicación",variant:"outlined","hide-details":"",required:"",rules:e.rules},null,8,["modelValue","rules"])]),_:1}),s(g),s(r,{cols:"12"},{default:l(()=>[fe,s(V,{content:e.inspection_form.resume,"onUpdate:content":t[6]||(t[6]=n=>e.inspection_form.resume=n),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"])]),_:1}),s(g),s(r,{cols:"12"},{default:l(()=>[e.inspection_form.fields&&e.inspection_form.fields.length?(h(),y(q,{key:0},{default:l(()=>[s(r,{cols:"12"},{default:l(()=>[he]),_:1}),(h(!0),B(Z,null,$(e.inspection_form.fields,(n,m)=>ee((h(),y(r,{cols:"12",lg:"6",key:m},{default:l(()=>[s(k,{modelValue:n.value,"onUpdate:modelValue":w=>n.value=w,label:n.name+" ("+u.isRequiredLabel(n.required)+")",variant:"outlined","hide-details":"",rules:n.required?e.rules:[]},null,8,["modelValue","onUpdate:modelValue","label","rules"])]),_:2},1024)),[[ie,n.active]])),128))]),_:1})):(h(),y(q,{key:1},{default:l(()=>[s(r,{cols:"12"},{default:l(()=>[ge]),_:1})]),_:1}))]),_:1})]),_:1}),s(q,null,{default:l(()=>[s(r,{cols:"12"},{default:l(()=>[qe,ve,s(V,{content:e.inspection_form.escala_condicion,"onUpdate:content":t[7]||(t[7]=n=>e.inspection_form.escala_condicion=n),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"]),ye,e.ct_risks.length?(h(),y(p,{key:0,modelValue:e.inspection_form.ct_risk_id,"onUpdate:modelValue":t[8]||(t[8]=n=>e.inspection_form.ct_risk_id=n),items:e.ct_risks,"item-title":"ct_risk","item-value":"ct_risk_id",variant:"outlined","hide-details":"",class:"w-50 rounded",density:"compact",style:te({"background-color":u.getBgColor(e.inspection_form.ct_risk_id)})},{item:l(({props:n,item:m})=>[s(I,b(n,{title:m.raw.ct_risk,style:{"background-color":m.raw.ct_color},value:"ct_risk"}),null,16,["title","style"])]),_:1},8,["modelValue","items","style"])):C("",!0)]),_:1})]),_:1}),s(U,{onClick:t[9]||(t[9]=n=>u.asignInspection(n)),disabled:!1,loading:!1,class:"mt-3"},{default:l(()=>[ne(" Guardar ")]),_:1})]),_:1})]),_:1},8,["loading","disabled"])]),_:1},512)])])}const Ce=le(ue,[["render",ke]]);export{Ce as default};

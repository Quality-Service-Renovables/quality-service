import{q as h,r as l,o as d,e as y,a as u,b as s,w as o,c as g,F as w,z as A,f as C,C as B,G as j,x as z,d as S}from"./app-CkRXx2h3.js";import{g as T}from"./api-CtSfpb4f.js";import{Q as N}from"./vue-quill.esm-bundler-DCC760JJ.js";import{_ as R}from"./PrimaryButton-qfLZJVy0.js";/* empty css                       */import{_ as D}from"./_plugin-vue_export-helper-DlAUqK2U.js";const F={components:{QuillEditor:N,PrimaryButton:R},props:{inspection_uuid:String,project:Object},data(){return{isUpdating:!1,loading:!1,inspection_form:{inspection_uuid:null,resume:"",recomendations:"",ct_inspection_code:"",status_code:"",client_uuid:"",project_uuid:"",fields:[]},inspections:[],inspectionsEquipmentsCategories:[],inspectionsEquipmentsToUseInInspections:[],loadingInspectionAsignin:!1,errorAssigningInspection:!1,equipmentsByCategory:[],ct_risks:[],rules:[t=>t?!0:"Este campo es requerido."]}},mounted(){this.getInspections(),this.getinspectionsEquipmentsCategories(),this.getRisks(),this.inspection_uuid!==null&&(this.isUpdating=!0,this.getInspection())},methods:{getInspections(){axios.get("api/inspection/categories").then(t=>{this.inspections=t.data.data}).catch(t=>{this.handleErrors(t)})},async getInspection(){try{this.loading=!0;const t=await T(this.inspection_uuid);this.inspection_form=t.data.data,this.inspection_form.ct_inspection_code=this.inspection_form.category.ct_inspection_code,this.inspection_form.ct_equipment_uuid=this.inspection_form.inspection_equipments.length>0?this.inspection_form.inspection_equipments[0].equipment.category.ct_equipment_uuid:null,this.inspection_form.equipments_uuid=this.inspection_form.inspection_equipments.map(i=>i.equipment.equipment_uuid),this.setEquipmentFields(this.inspection_form.ct_equipment_uuid),this.loading=!1}catch(t){this.loading=!1,this.handleErrors(t)}},getinspectionsEquipmentsCategories(){axios.get("api/equipment/categories").then(t=>{this.inspectionsEquipmentsCategories=t.data.data,this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsCategories.filter(i=>i.ct_equipment_code==="inspeccion"),this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsToUseInInspections.length?this.inspectionsEquipmentsToUseInInspections[0].equipments:[]}).catch(t=>{this.handleErrors(t)})},setEquipmentFields(t){if(console.log("Entro a setEquipmentFields"),console.log("ct_equipment_uuid: "+t),t){this.inspection_form.fields=null;let i=this.inspectionsEquipmentsCategories.find(r=>r.ct_equipment_uuid===t);this.inspection_form.fields=i.required_fields_report&&i.required_fields_report.length>0?JSON.parse(i.required_fields_report).fields:[];let c=this.inspection_form.equipment_fields_report!=null?JSON.parse(this.inspection_form.equipment_fields_report):null;this.inspection_form.fields.forEach(r=>{if(c&&c.length>0){let e=c.find(p=>p.key===r.key);r.value=e?e.value:""}else r.value=""}),this.equipmentsByCategory=i.equipments.length>0?i.equipments:[]}},isRequiredLabel(t){return t?"Requerido":"Opcional"},async asignInspection(t){t.preventDefault();const{valid:i}=await this.$refs.form.validate();if(i){console.log("Asignar inspección"),this.loadingInspectionAsignin=!0;try{await this.createInspection(),await this.asignEquipmentToInspection()}catch{h.error("Error al asignar inspección, favor de verificar los datos ingresados.")}this.loadingInspectionAsignin=!1,this.errorAssigningInspection||(console.log("this.errorAssigningInspection: "+this.errorAssigningInspection),this.$inertia.reload())}else h.error("Parece que faltan algunos campos por rellenar.")},createInspection(){return new Promise((t,i)=>{let c=null;if(this.isUpdating){console.log("Actualizando inspección"),c=()=>axios.put("api/inspections/"+this.inspection_form.inspection_uuid,r);let r={resume:this.inspection_form.resume,ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id}}else{console.log("Creando inspección");let r={resume:this.inspection_form.resume,ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id};c=()=>axios.post("api/inspections",r)}h.promise(c(),{loading:this.isUpdating?"Actualizando inspección...":"Asignando inspección...",success:r=>{this.inspection_form.inspection_uuid=r.data.data.inspection_uuid,this.$emit("setInspectionUuid",this.inspection_form.inspection_uuid);let e=this.isUpdating?"Inspección actualizada correctamente":"Inspección asignada correctamente";return t(e),e},error:r=>{this.errorAssigningInspection=!0,this.handleErrors(r),i(r)}})})},asignEquipmentToInspection(){return new Promise((t,i)=>{let c=this.inspection_form.equipments_uuid.map(e=>({equipment_uuid:e}));const r=()=>this.isUpdating?axios.put("api/inspection/equipments/"+this.inspection_form.inspection_uuid,{inspection_uuid:this.inspection_form.inspection_uuid,equipments:c}):axios.post("api/inspection/equipments",{inspection_uuid:this.inspection_form.inspection_uuid,equipments:c});h.promise(r(),{loading:this.isUpdating?"Actualizando equipos de inspección...":"Asignando equipos a inspección...",success:e=>{let p=this.isUpdating?"Actualización completada correctamente":"Asignación completada correctamente";return t(p),p},error:e=>{this.errorAssigningInspection=!0,this.handleErrors(e),i(e)}})})},getRisks(){axios.get("api/risks").then(t=>{this.ct_risks=t.data.data}).catch(t=>{this.handleErrors(t)})},getBgColor(t){let i=this.ct_risks.filter(c=>t===c.ct_risk_id);return i.length>0?i[0].ct_color:""}}},P={class:"max-w-7xl mx-auto sm:px-4 lg:px-6 mb-5 pb-5"},O={class:"overflow-hidden shadow-sm sm:rounded-lg"},J=u("p",{class:"text-grey mb-2 text-h5 font-weight-bold"}," Información del proyecto ",-1),Q=u("p",{class:"text-primary"},"Rellena la información relacionada a la inspección a realizar.",-1),L=u("p",{class:"text-grey mb-1"},"Define el resumen de la inspección a realizar (opcional) ",-1),G=u("p",{class:"text-primary"},"Define los datos del equipo a inspeccionar. ",-1),H=u("p",{class:"text-red mb-2"},"*No se han definido campos para la categoría seleccionada",-1),K=u("p",{class:"text-primary mb-2"},"Define la Escala de condición.",-1),M=u("p",{class:"text-grey mb-1"},"Escala de condición ",-1),W=u("p",{class:"mt-3 text-grey"}," Riesgo:",-1);function X(t,i,c,r,e,p){const I=l("v-divider"),_=l("v-autocomplete"),a=l("v-col"),q=l("v-text-field"),v=l("QuillEditor"),m=l("v-row"),E=l("v-list-item"),x=l("PrimaryButton"),k=l("v-card-text"),b=l("v-card"),U=l("v-form");return d(),y("div",P,[u("div",O,[s(U,{ref:"form"},{default:o(()=>[s(b,{loading:e.loading,disabled:e.loading},{default:o(()=>[s(k,null,{default:o(()=>[J,Q,s(I,{class:"my-3"}),s(m,null,{default:o(()=>[s(a,{cols:"12"},{default:o(()=>[s(_,{modelValue:e.inspection_form.ct_inspection_code,"onUpdate:modelValue":i[0]||(i[0]=n=>e.inspection_form.ct_inspection_code=n),items:e.inspections,"item-title":"ct_inspection","item-value":"ct_inspection_code",label:"Seleccionar inspección",variant:"outlined","hide-details":"",required:"",rules:e.rules},null,8,["modelValue","items","rules"])]),_:1}),s(a,{cols:"12",lg:"6"},{default:o(()=>[s(_,{modelValue:e.inspection_form.ct_equipment_uuid,"onUpdate:modelValue":[i[1]||(i[1]=n=>e.inspection_form.ct_equipment_uuid=n),i[2]||(i[2]=n=>p.setEquipmentFields(e.inspection_form.ct_equipment_uuid))],items:e.inspectionsEquipmentsCategories,"item-title":"ct_equipment","item-value":"ct_equipment_uuid",label:"Seleccionar categoría de equipo a inspeccionar",variant:"outlined","hide-details":"",required:""},null,8,["modelValue","items"])]),_:1}),s(a,{cols:"12",lg:"6"},{default:o(()=>[s(_,{modelValue:e.inspection_form.equipments_uuid,"onUpdate:modelValue":i[3]||(i[3]=n=>e.inspection_form.equipments_uuid=n),items:e.equipmentsByCategory,"item-title":"equipment","item-value":"equipment_uuid",label:"Seleccionar equipos a utilizar en la inspección",variant:"outlined","hide-details":"",multiple:"",chips:"",clearable:"",required:"",rules:e.rules},null,8,["modelValue","items","rules"])]),_:1}),s(a,{cols:"12"},{default:o(()=>[s(q,{modelValue:e.inspection_form.location,"onUpdate:modelValue":i[4]||(i[4]=n=>e.inspection_form.location=n),label:"Ubicación",variant:"outlined","hide-details":"",required:"",rules:e.rules},null,8,["modelValue","rules"])]),_:1}),s(a,{cols:"12"},{default:o(()=>[L,s(v,{content:e.inspection_form.resume,"onUpdate:content":i[5]||(i[5]=n=>e.inspection_form.resume=n),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"])]),_:1}),s(a,{cols:"12"},{default:o(()=>[e.inspection_form.fields&&e.inspection_form.fields.length?(d(),g(m,{key:0},{default:o(()=>[s(a,{cols:"12"},{default:o(()=>[G]),_:1}),(d(!0),y(w,null,A(e.inspection_form.fields,(n,f)=>C((d(),g(a,{cols:"12",lg:"6",key:f},{default:o(()=>[s(q,{modelValue:n.value,"onUpdate:modelValue":V=>n.value=V,label:n.name+" ("+p.isRequiredLabel(n.required)+")",variant:"outlined","hide-details":"",rules:n.required?e.rules:[]},null,8,["modelValue","onUpdate:modelValue","label","rules"])]),_:2},1024)),[[B,n.active]])),128))]),_:1})):(d(),g(m,{key:1},{default:o(()=>[s(a,{cols:"12"},{default:o(()=>[H]),_:1})]),_:1}))]),_:1})]),_:1}),s(m,null,{default:o(()=>[s(a,{cols:"12"},{default:o(()=>[K,M,s(v,{content:e.inspection_form.escala_condicion,"onUpdate:content":i[6]||(i[6]=n=>e.inspection_form.escala_condicion=n),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"]),W,s(_,{modelValue:e.inspection_form.ct_risk_id,"onUpdate:modelValue":i[7]||(i[7]=n=>e.inspection_form.ct_risk_id=n),items:e.ct_risks,"item-title":"ct_risk","item-value":"ct_risk_id",variant:"outlined","hide-details":"",class:"w-50 rounded",density:"compact",style:j({"background-color":p.getBgColor(e.inspection_form.ct_risk_id)})},{item:o(({props:n,item:f})=>[s(E,z(n,{title:f.raw.ct_risk,style:{"background-color":f.raw.ct_color},value:"ct_risk"}),null,16,["title","style"])]),_:1},8,["modelValue","items","style"])]),_:1})]),_:1}),s(x,{onClick:i[8]||(i[8]=n=>p.asignInspection(n)),disabled:!1,loading:!1,class:"mt-3"},{default:o(()=>[S(" Guardar ")]),_:1})]),_:1})]),_:1},8,["loading","disabled"])]),_:1},512)])])}const ne=D(F,[["render",X]]);export{ne as default};

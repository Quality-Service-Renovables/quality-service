import{G as j,H as T,I as R,J as M,K as S,M as N,N as Y,P as z,R as O,S as J,U as L,V as Q,j as K,W as G,X as H,Y as P,_ as D,$ as A,b as s,a0 as W,x as b,q as x,r as d,o as v,e as F,a as m,w as l,c as C,F as X,z as Z,f as $,C as ee,a1 as ie,d as te}from"./app-CGbl2Kng.js";import{g as ne}from"./api-Wr_1yEQi.js";import{Q as se}from"./vue-quill.esm-bundler-DIvxYs1H.js";import{_ as oe}from"./PrimaryButton-BvVGa27m.js";/* empty css                       */import{h as B}from"./moment-Cl4UOzQZ.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const re=j({hideActions:Boolean,...T(),...R(),...M({placeholder:"mm/dd/yyyy",prependIcon:"$calendar"}),...S(N({weeksInMonth:"dynamic",hideHeader:!0}),["active"])},"VDateInput"),ce=Y()({name:"VDateInput",props:re(),emits:{"update:modelValue":i=>!0},setup(i,t){let{slots:c}=t;const{t:r}=z(),e=O(),{isFocused:p,focus:q,blur:U}=J(i),o=L(i,"modelValue",i.multiple?[]:null),u=Q(!1),y=K(()=>{const a=G(o.value);if(!a.length)return null;if(i.multiple===!0)return r("$vuetify.datePicker.itemsSelected",a.length);if(i.multiple==="range"){const _=a[0],h=a[a.length-1];return e.isValid(_)&&e.isValid(h)?`${e.format(_,"keyboardDate")} - ${e.format(h,"keyboardDate")}`:""}return e.isValid(o.value)?e.format(o.value,"keyboardDate"):""});function k(a){if(a.key!=="Enter")return;if(!u.value||!p.value){u.value=!0;return}const _=a.target;o.value=e.date(_.value)}function f(a){a.preventDefault(),a.stopPropagation(),u.value=!0}function w(){u.value=!1}H(()=>{const a=P.filterProps(i),_=D.filterProps(S(i,["active"])),h=A.filterProps(i);return s(A,b(h,{modelValue:y.value,onKeydown:k,focused:u.value||p.value,onFocus:q,onBlur:U,"onClick:control":f,"onClick:prepend":f}),{default:()=>{var V;return[s(W,{modelValue:u.value,"onUpdate:modelValue":n=>u.value=n,activator:"parent","min-width":"0",closeOnContentClick:!1,openOnClick:!1},{default:()=>[s(P,b(a,{modelValue:o.value,"onUpdate:modelValue":n=>o.value=n,onSave:w}),{default:n=>{let{actions:g,model:I}=n;return s(D,b(_,{modelValue:i.hideActions?o.value:I.value,"onUpdate:modelValue":E=>{i.hideActions?(o.value=E,i.multiple||(u.value=!1)):I.value=E},onMousedown:E=>E.preventDefault()}),{actions:i.hideActions?void 0:()=>g})}})]}),(V=c.default)==null?void 0:V.call(c)]}})})}}),ae={components:{QuillEditor:se,PrimaryButton:oe,VDateInput:ce},props:{inspection_uuid:String,project:Object},data(){return{isUpdating:!1,loading:!1,inspection_form:{inspection_uuid:null,resume:"",recomendations:"",ct_inspection_code:"",status_code:"",client_uuid:"",project_uuid:"",fields:[]},inspections:[],inspectionsEquipmentsCategories:[],inspectionsEquipmentsToUseInInspections:[],loadingInspectionAsignin:!1,errorAssigningInspection:!1,equipmentsByCategory:[],ct_risks:[],rules:[i=>i?!0:"Este campo es requerido."]}},mounted(){this.getInspections(),this.getinspectionsEquipmentsCategories(),this.getRisks(),this.inspection_uuid!==null&&(this.isUpdating=!0,this.getInspection())},methods:{getInspections(){axios.get("api/inspection/categories").then(i=>{this.inspections=i.data.data}).catch(i=>{this.handleErrors(i)})},async getInspection(){try{this.loading=!0;const i=await ne(this.inspection_uuid);this.inspection_form=i.data.data,this.inspection_form.ct_inspection_code=this.inspection_form.category.ct_inspection_code,this.inspection_form.ct_equipment_uuid=this.inspection_form.inspection_equipments.length>0?this.inspection_form.inspection_equipments[0].equipment.category.ct_equipment_uuid:null,this.inspection_form.equipments_uuid=this.inspection_form.inspection_equipments.map(t=>t.equipment.equipment_uuid),this.setEquipmentFields(this.inspection_form.ct_equipment_uuid),this.loading=!1}catch(i){this.loading=!1,this.handleErrors(i)}},getinspectionsEquipmentsCategories(){axios.get("api/equipment/categories").then(i=>{this.inspectionsEquipmentsCategories=i.data.data,this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsCategories.filter(t=>t.ct_equipment_code==="inspeccion"),this.inspectionsEquipmentsToUseInInspections=this.inspectionsEquipmentsToUseInInspections.length?this.inspectionsEquipmentsToUseInInspections[0].equipments:[]}).catch(i=>{this.handleErrors(i)})},setEquipmentFields(i){if(console.log("Entro a setEquipmentFields"),console.log("ct_equipment_uuid: "+i),i){this.inspection_form.fields=null;let t=this.inspectionsEquipmentsCategories.find(r=>r.ct_equipment_uuid===i);this.inspection_form.fields=t.required_fields_report&&t.required_fields_report.length>0?JSON.parse(t.required_fields_report).fields:[];let c=this.inspection_form.equipment_fields_report!=null?JSON.parse(this.inspection_form.equipment_fields_report):null;this.inspection_form.fields.forEach(r=>{if(c&&c.length>0){let e=c.find(p=>p.key===r.key);r.value=e?e.value:""}else r.value=""}),this.equipmentsByCategory=t.equipments.length>0?t.equipments:[]}},isRequiredLabel(i){return i?"Requerido":"Opcional"},async asignInspection(i){i.preventDefault();const{valid:t}=await this.$refs.form.validate();if(t){console.log("Asignar inspección"),this.loadingInspectionAsignin=!0;try{await this.createInspection(),await this.asignEquipmentToInspection()}catch{x.error("Error al asignar inspección, favor de verificar los datos ingresados.")}this.loadingInspectionAsignin=!1,this.errorAssigningInspection||(console.log("this.errorAssigningInspection: "+this.errorAssigningInspection),this.$inertia.reload())}else x.error("Parece que faltan algunos campos por rellenar.")},createInspection(){return new Promise((i,t)=>{let c=null;if(this.isUpdating){console.log("Actualizando inspección"),c=()=>axios.put("api/inspections/"+this.inspection_form.inspection_uuid,r);let r={resume:this.inspection_form.resume,ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id,inspection_date:B(this.inspection_form.inspection_date).format("YYYY-MM-DD")}}else{console.log("Creando inspección");let r={resume:this.inspection_form.resume,ct_inspection_code:this.inspection_form.ct_inspection_code,status_code:this.inspection_form.status_code,equipment_uuid:this.inspection_form.equipment_uuid,project_uuid:this.project.project_uuid,client_uuid:this.project.client.client_uuid,location:this.inspection_form.location,equipment_fields_report:JSON.stringify(this.inspection_form.fields),escala_condicion:this.inspection_form.escala_condicion,ct_risk_id:this.inspection_form.ct_risk_id,inspection_date:B(this.inspection_form.inspection_date).format("YYYY-MM-DD")};c=()=>axios.post("api/inspections",r)}x.promise(c(),{loading:this.isUpdating?"Actualizando inspección...":"Asignando inspección...",success:r=>{this.inspection_form.inspection_uuid=r.data.data.inspection_uuid,this.$emit("setInspectionUuid",this.inspection_form.inspection_uuid);let e=this.isUpdating?"Inspección actualizada correctamente":"Inspección asignada correctamente";return i(e),e},error:r=>{this.errorAssigningInspection=!0,this.handleErrors(r),t(r)}})})},asignEquipmentToInspection(){return new Promise((i,t)=>{let c=this.inspection_form.equipments_uuid.map(e=>({equipment_uuid:e}));const r=()=>this.isUpdating?axios.put("api/inspection/equipments/"+this.inspection_form.inspection_uuid,{inspection_uuid:this.inspection_form.inspection_uuid,equipments:c}):axios.post("api/inspection/equipments",{inspection_uuid:this.inspection_form.inspection_uuid,equipments:c});x.promise(r(),{loading:this.isUpdating?"Actualizando equipos de inspección...":"Asignando equipos a inspección...",success:e=>{let p=this.isUpdating?"Actualización completada correctamente":"Asignación completada correctamente";return i(p),p},error:e=>{this.errorAssigningInspection=!0,this.handleErrors(e),t(e)}})})},getRisks(){axios.get("api/risks").then(i=>{this.ct_risks=i.data.data}).catch(i=>{this.handleErrors(i)})},getBgColor(i){let t=this.ct_risks.filter(c=>i===c.ct_risk_id);return t.length>0?t[0].ct_color:""}}},ue={class:"max-w-7xl mx-auto sm:px-4 lg:px-6 mb-5 pb-5"},pe={class:"overflow-hidden shadow-sm sm:rounded-lg"},de=m("p",{class:"text-grey mb-2 text-h5 font-weight-bold"}," Información de la inspección ",-1),me=m("p",{class:"text-primary"},"Rellena la información relacionada a la inspección.",-1),_e=m("p",{class:"text-grey mb-1"},"Define el resumen de la inspección (opcional) ",-1),fe=m("p",{class:"text-primary"},"Define los datos del equipo. ",-1),he=m("p",{class:"text-red mb-2"},"*No se han definido campos para la categoría seleccionada",-1),ge=m("p",{class:"text-primary mb-2"},"Define la Escala de condición.",-1),qe=m("p",{class:"text-grey mb-1"},"Escala de condición ",-1),ve=m("p",{class:"mt-3 text-grey"}," Riesgo:",-1);function ye(i,t,c,r,e,p){const q=d("v-divider"),U=d("v-date-input"),o=d("v-col"),u=d("v-autocomplete"),y=d("v-text-field"),k=d("QuillEditor"),f=d("v-row"),w=d("v-list-item"),a=d("PrimaryButton"),_=d("v-card-text"),h=d("v-card"),V=d("v-form");return v(),F("div",ue,[m("div",pe,[s(V,{ref:"form"},{default:l(()=>[s(h,{loading:e.loading,disabled:e.loading},{default:l(()=>[s(_,null,{default:l(()=>[de,me,s(q,{class:"my-3"}),s(f,null,{default:l(()=>[s(o,{cols:"12"},{default:l(()=>[s(U,{label:"Fecha de inspección",variant:"outlined","prepend-icon":"",modelValue:e.inspection_form.inspection_date,"onUpdate:modelValue":t[0]||(t[0]=n=>e.inspection_form.inspection_date=n),"hide-details":"",required:"",rules:e.rules},null,8,["modelValue","rules"])]),_:1}),s(o,{cols:"12"},{default:l(()=>[s(u,{modelValue:e.inspection_form.ct_inspection_code,"onUpdate:modelValue":t[1]||(t[1]=n=>e.inspection_form.ct_inspection_code=n),items:e.inspections,"item-title":"ct_inspection","item-value":"ct_inspection_code",label:"Seleccionar inspección",variant:"outlined","hide-details":"",required:"",rules:e.rules},null,8,["modelValue","items","rules"])]),_:1}),s(o,{cols:"12",lg:"6"},{default:l(()=>[s(u,{modelValue:e.inspection_form.ct_equipment_uuid,"onUpdate:modelValue":[t[2]||(t[2]=n=>e.inspection_form.ct_equipment_uuid=n),t[3]||(t[3]=n=>p.setEquipmentFields(e.inspection_form.ct_equipment_uuid))],items:e.inspectionsEquipmentsCategories,"item-title":"ct_equipment","item-value":"ct_equipment_uuid",label:"Seleccionar categoría de equipo a inspeccionar",variant:"outlined","hide-details":"",required:""},null,8,["modelValue","items"])]),_:1}),s(o,{cols:"12",lg:"6"},{default:l(()=>[s(u,{modelValue:e.inspection_form.equipments_uuid,"onUpdate:modelValue":t[4]||(t[4]=n=>e.inspection_form.equipments_uuid=n),items:e.equipmentsByCategory,"item-title":"equipment","item-value":"equipment_uuid",label:"Seleccionar equipos a utilizar en la inspección",variant:"outlined","hide-details":"",multiple:"",chips:"",clearable:"",required:"",rules:e.rules},null,8,["modelValue","items","rules"])]),_:1}),s(o,{cols:"12"},{default:l(()=>[s(y,{modelValue:e.inspection_form.location,"onUpdate:modelValue":t[5]||(t[5]=n=>e.inspection_form.location=n),label:"Ubicación",variant:"outlined","hide-details":"",required:"",rules:e.rules},null,8,["modelValue","rules"])]),_:1}),s(q),s(o,{cols:"12"},{default:l(()=>[_e,s(k,{content:e.inspection_form.resume,"onUpdate:content":t[6]||(t[6]=n=>e.inspection_form.resume=n),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"])]),_:1}),s(q),s(o,{cols:"12"},{default:l(()=>[e.inspection_form.fields&&e.inspection_form.fields.length?(v(),C(f,{key:0},{default:l(()=>[s(o,{cols:"12"},{default:l(()=>[fe]),_:1}),(v(!0),F(X,null,Z(e.inspection_form.fields,(n,g)=>$((v(),C(o,{cols:"12",lg:"6",key:g},{default:l(()=>[s(y,{modelValue:n.value,"onUpdate:modelValue":I=>n.value=I,label:n.name+" ("+p.isRequiredLabel(n.required)+")",variant:"outlined","hide-details":"",rules:n.required?e.rules:[]},null,8,["modelValue","onUpdate:modelValue","label","rules"])]),_:2},1024)),[[ee,n.active]])),128))]),_:1})):(v(),C(f,{key:1},{default:l(()=>[s(o,{cols:"12"},{default:l(()=>[he]),_:1})]),_:1}))]),_:1})]),_:1}),s(f,null,{default:l(()=>[s(o,{cols:"12"},{default:l(()=>[ge,qe,s(k,{content:e.inspection_form.escala_condicion,"onUpdate:content":t[7]||(t[7]=n=>e.inspection_form.escala_condicion=n),theme:"snow",toolbar:"essential",heigth:"100%",contentType:"html"},null,8,["content"]),ve,s(u,{modelValue:e.inspection_form.ct_risk_id,"onUpdate:modelValue":t[8]||(t[8]=n=>e.inspection_form.ct_risk_id=n),items:e.ct_risks,"item-title":"ct_risk","item-value":"ct_risk_id",variant:"outlined","hide-details":"",class:"w-50 rounded",density:"compact",style:ie({"background-color":p.getBgColor(e.inspection_form.ct_risk_id)})},{item:l(({props:n,item:g})=>[s(w,b(n,{title:g.raw.ct_risk,style:{"background-color":g.raw.ct_color},value:"ct_risk"}),null,16,["title","style"])]),_:1},8,["modelValue","items","style"])]),_:1})]),_:1}),s(a,{onClick:t[9]||(t[9]=n=>p.asignInspection(n)),disabled:!1,loading:!1,class:"mt-3"},{default:l(()=>[te(" Guardar ")]),_:1})]),_:1})]),_:1},8,["loading","disabled"])]),_:1},512)])])}const we=le(ae,[["render",ye]]);export{we as default};
